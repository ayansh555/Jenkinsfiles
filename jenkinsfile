pipeline {
    agent any

 parameters {
        string(name: "GIT_BRANCH", defaultValue: "main", description: "Git branch to build")
        choice(name: "RUN_SONAR", choices: ["yes", "no"], description: "Run SonarQube scan")
        choice(name: "RUN_TESTS", choices: ["yes", "no"], description: "Run Maven tests")
    }

    environment {
        SONAR_SERVER = 'sonarqube'
        SONAR_URL = 'http://13.203.69.22:9000'
        EMAIL_TO = 'ayanshkaran188@gmail.com'
    }

    stages {

        stage('Git Checkout') {
            steps {
                git branch: 'main',
                    credentialsId: '97ef8178-99be-4e06-b7f6-0c48ea23c967',
                    url: 'https://github.com/ayansh555/spring.git'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('SonarQube Scan') {
            steps {
                withSonarQubeEnv(installationName: 'sonarqube', credentialsId: 'sonar-token') {
                    sh 'mvn clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar'
                }
            }
        }

        stage('Package') {
            steps {
                sh 'mvn clean package'
            }
        }
    }

    post {
        success {
            emailext(
                subject: "✅ Jenkins Build SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                        Hello Ayansh,
                        
                        Your Jenkins build completed successfully ✅
                        
                        Job Name  : ${env.JOB_NAME}
                        Build No  : ${env.BUILD_NUMBER}
                        Build URL : ${env.BUILD_URL}
                        
                        Maven build and package completed successfully.
                        
                        Regards,
                        Jenkins
                        """,
                to: "ayanshkaran188@gmail.com"
            )
        }

        failure {
            emailext(
                subject: "❌ Jenkins Build FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                        Hello Ayansh,
                        
                        Your Jenkins build has FAILED ❌
                        
                        Job Name  : ${env.JOB_NAME}
                        Build No  : ${env.BUILD_NUMBER}
                        Build URL : ${env.BUILD_URL}
                        
                        Please check Jenkins console output for details.
                        
                        Regards,
                        Jenkins
                        """,
                to: "ayanshkaran188@gmail.com"
            )
        }
    }
}
